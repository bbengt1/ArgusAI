# Architecture Document

## Table of Contents

- [Architecture Document](#table-of-contents)
  - [ArgusAI - MVP + Phase 2](./argusai-mvp-phase-2.md)
  - [Executive Summary](./executive-summary.md)
  - [Project Initialization](./project-initialization.md)
    - [Frontend Setup](./project-initialization.md#frontend-setup)
    - [Backend Setup](./project-initialization.md#backend-setup)
  - [Decision Summary](./decision-summary.md)
  - [Technology Stack Details](./technology-stack-details.md)
    - [Core Technologies](./technology-stack-details.md#core-technologies)
    - [Integration Points](./technology-stack-details.md#integration-points)
  - [Complete Project Structure](./complete-project-structure.md)
  - [Epic to Architecture Mapping](./epic-to-architecture-mapping.md)
  - [Data Architecture](./data-architecture.md)
    - [Database Schema](./data-architecture.md#database-schema)
    - [Data Relationships](./data-architecture.md#data-relationships)
  - [API Contracts](./api-contracts.md)
    - [REST API Endpoints](./api-contracts.md#rest-api-endpoints)
      - [Cameras](./api-contracts.md#cameras)
      - [Events](./api-contracts.md#events)
      - [Alert Rules](./api-contracts.md#alert-rules)
      - [Settings](./api-contracts.md#settings)
      - [Health](./api-contracts.md#health)
      - [Authentication (Phase 1.5)](./api-contracts.md#authentication-phase-15)
    - [WebSocket Protocol](./api-contracts.md#websocket-protocol)
  - [Implementation Patterns](./implementation-patterns.md)
    - [Naming Conventions](./implementation-patterns.md#naming-conventions)
    - [Code Organization](./implementation-patterns.md#code-organization)
    - [Error Handling](./implementation-patterns.md#error-handling)
    - [Logging Standards](./implementation-patterns.md#logging-standards)
    - [Date/Time Handling](./implementation-patterns.md#datetime-handling)
    - [Testing Patterns](./implementation-patterns.md#testing-patterns)
  - [Security Architecture](./security-architecture.md)
    - [Authentication Flow (Phase 1.5)](./security-architecture.md#authentication-flow-phase-15)
    - [API Key Encryption](./security-architecture.md#api-key-encryption)
    - [Input Validation](./security-architecture.md#input-validation)
    - [CORS Configuration](./security-architecture.md#cors-configuration)
  - [Performance Considerations](./performance-considerations.md)
    - [Backend Optimizations](./performance-considerations.md#backend-optimizations)
    - [Frontend Optimizations](./performance-considerations.md#frontend-optimizations)
  - [Deployment Architecture](./deployment-architecture.md)
    - [Development Environment](./deployment-architecture.md#development-environment)
    - [Production Deployment (Docker)](./deployment-architecture.md#production-deployment-docker)
  - [Architecture Decision Records (ADRs)](./architecture-decision-records-adrs.md)
    - [ADR-001: Event-Driven Architecture](./architecture-decision-records-adrs.md#adr-001-event-driven-architecture)
    - [ADR-002: Description Storage vs Video Storage](./architecture-decision-records-adrs.md#adr-002-description-storage-vs-video-storage)
    - [ADR-003: SQLite for MVP Database](./architecture-decision-records-adrs.md#adr-003-sqlite-for-mvp-database)
    - [ADR-004: FastAPI BackgroundTasks vs External Queue](./architecture-decision-records-adrs.md#adr-004-fastapi-backgroundtasks-vs-external-queue)
    - [ADR-005: Multi-Provider AI with Fallback](./architecture-decision-records-adrs.md#adr-005-multi-provider-ai-with-fallback)
    - [ADR-006: Next.js App Router vs Pages Router](./architecture-decision-records-adrs.md#adr-006-nextjs-app-router-vs-pages-router)
    - [ADR-007: shadcn/ui vs Material-UI vs Chakra](./architecture-decision-records-adrs.md#adr-007-shadcnui-vs-material-ui-vs-chakra)
  - [Glossary](./glossary.md)
  - [Next Steps](./next-steps.md)
  - [Phase 2 Additions](./phase-2-additions.md)
    - [Phase 2 Executive Summary](./phase-2-additions.md#phase-2-executive-summary)
    - [Phase 2 Technology Stack Additions](./phase-2-additions.md#phase-2-technology-stack-additions)
    - [Phase 2 Project Structure Additions](./phase-2-additions.md#phase-2-project-structure-additions)
    - [Phase 2 Database Schema Additions](./phase-2-additions.md#phase-2-database-schema-additions)
    - [Phase 2 API Contracts](./phase-2-additions.md#phase-2-api-contracts)
      - [UniFi Protect Controller Endpoints](./phase-2-additions.md#unifi-protect-controller-endpoints)
      - [xAI Grok Provider](./phase-2-additions.md#xai-grok-provider)
    - [Phase 2 Service Architecture](./phase-2-additions.md#phase-2-service-architecture)
      - [ProtectService (NEW)](./phase-2-additions.md#protectservice-new)
      - [ProtectEventHandler (NEW)](./phase-2-additions.md#protecteventhandler-new)
      - [CorrelationService (NEW)](./phase-2-additions.md#correlationservice-new)
      - [AIService Extensions](./phase-2-additions.md#aiservice-extensions)
    - [Phase 2 WebSocket Protocol Additions](./phase-2-additions.md#phase-2-websocket-protocol-additions)
    - [Phase 2 Security Considerations](./phase-2-additions.md#phase-2-security-considerations)
    - [Phase 2 Performance Considerations](./phase-2-additions.md#phase-2-performance-considerations)
    - [Phase 2 Epic to Architecture Mapping](./phase-2-additions.md#phase-2-epic-to-architecture-mapping)
    - [Phase 2 Architecture Decision Records](./phase-2-additions.md#phase-2-architecture-decision-records)
      - [ADR-008: Native Integration over RTSP Polling](./phase-2-additions.md#adr-008-native-integration-over-rtsp-polling)
      - [ADR-009: Single Controller for Phase 2](./phase-2-additions.md#adr-009-single-controller-for-phase-2)
      - [ADR-010: Time-Window Based Correlation](./phase-2-additions.md#adr-010-time-window-based-correlation)
      - [ADR-011: xAI Grok as Additional Provider](./phase-2-additions.md#adr-011-xai-grok-as-additional-provider)
    - [Phase 2 Integration Diagram](./phase-2-additions.md#phase-2-integration-diagram)
    - [Phase 2 Validation Checklist](./phase-2-additions.md#phase-2-validation-checklist)
  - [Phase 3 Additions](./phase-3-additions.md)
    - [Phase 3 Executive Summary](./phase-3-additions.md#phase-3-executive-summary)
    - [Phase 3 Technology Stack Additions](./phase-3-additions.md#phase-3-technology-stack-additions)
    - [Phase 3 Project Structure Additions](./phase-3-additions.md#phase-3-project-structure-additions)
    - [Phase 3 Database Schema Additions](./phase-3-additions.md#phase-3-database-schema-additions)
    - [Phase 3 Service Architecture](./phase-3-additions.md#phase-3-service-architecture)
      - [ClipService (NEW)](./phase-3-additions.md#clipservice-new)
      - [FrameExtractor (NEW)](./phase-3-additions.md#frameextractor-new)
      - [AIService Extensions](./phase-3-additions.md#aiservice-extensions)
      - [CostTracker (NEW)](./phase-3-additions.md#costtracker-new)
    - [Phase 3 Event Processing Flow](./phase-3-additions.md#phase-3-event-processing-flow)
    - [Phase 3 Fallback Chain](./phase-3-additions.md#phase-3-fallback-chain)
    - [Phase 3 API Additions](./phase-3-additions.md#phase-3-api-additions)
      - [Camera Analysis Mode](./phase-3-additions.md#camera-analysis-mode)
      - [AI Usage/Cost Endpoints](./phase-3-additions.md#ai-usagecost-endpoints)
    - [Phase 3 Frontend Components](./phase-3-additions.md#phase-3-frontend-components)
      - [AnalysisModeSelector](./phase-3-additions.md#analysismodeselector)
      - [AnalysisModeBadge](./phase-3-additions.md#analysismodebadge)
      - [ConfidenceIndicator](./phase-3-additions.md#confidenceindicator)
    - [Phase 3 Configuration](./phase-3-additions.md#phase-3-configuration)
    - [Phase 3 Epic to Architecture Mapping](./phase-3-additions.md#phase-3-epic-to-architecture-mapping)
    - [Phase 3 Architecture Decision Records](./phase-3-additions.md#phase-3-architecture-decision-records)
      - [ADR-012: Temporary Clip Storage](./phase-3-additions.md#adr-012-temporary-clip-storage)
      - [ADR-013: Evenly-Spaced Frame Selection](./phase-3-additions.md#adr-013-evenly-spaced-frame-selection)
      - [ADR-014: Multi-Provider Video Support Detection](./phase-3-additions.md#adr-014-multi-provider-video-support-detection)
      - [ADR-015: Cost Estimation Approach](./phase-3-additions.md#adr-015-cost-estimation-approach)
    - [Phase 3 Performance Considerations](./phase-3-additions.md#phase-3-performance-considerations)
    - [Phase 3 Validation Checklist](./phase-3-additions.md#phase-3-validation-checklist)
  - [Phase 4 Additions](./phase-4-additions.md)
    - [Phase 4 Executive Summary](./phase-4-additions.md#phase-4-executive-summary)
    - [Phase 4 Technology Stack Additions](./phase-4-additions.md#phase-4-technology-stack-additions)
    - [Phase 4 Project Structure Additions](./phase-4-additions.md#phase-4-project-structure-additions)
    - [Phase 4 Database Schema Additions](./phase-4-additions.md#phase-4-database-schema-additions)
    - [Phase 4 API Contracts](./phase-4-additions.md#phase-4-api-contracts)
      - [Context API](./phase-4-additions.md#context-api)
      - [Push Notification API](./phase-4-additions.md#push-notification-api)
      - [Summaries API](./phase-4-additions.md#summaries-api)
      - [Feedback API](./phase-4-additions.md#feedback-api)
      - [Integrations API](./phase-4-additions.md#integrations-api)
    - [Phase 4 Service Architecture](./phase-4-additions.md#phase-4-service-architecture)
      - [Context Service Flow](./phase-4-additions.md#context-service-flow)
      - [Push Notification Flow](./phase-4-additions.md#push-notification-flow)
      - [MQTT Publishing Flow](./phase-4-additions.md#mqtt-publishing-flow)
    - [Phase 4 ADRs](./phase-4-additions.md#phase-4-adrs)
      - [ADR-P4-001: Image Embedding Model Selection](./phase-4-additions.md#adr-p4-001-image-embedding-model-selection)
      - [ADR-P4-002: MQTT vs REST for Home Assistant](./phase-4-additions.md#adr-p4-002-mqtt-vs-rest-for-home-assistant)
      - [ADR-P4-003: Vector Database Choice](./phase-4-additions.md#adr-p4-003-vector-database-choice)
    - [Phase 4 Performance Considerations](./phase-4-additions.md#phase-4-performance-considerations)
    - [Phase 4 Validation Checklist](./phase-4-additions.md#phase-4-validation-checklist)
  - [Phase 5 Additions](./phase-5-additions.md)
    - [Phase 5 Technology Stack Additions](./phase-5-additions.md#phase-5-technology-stack-additions)
    - [Phase 5 Project Structure Additions](./phase-5-additions.md#phase-5-project-structure-additions)
    - [Phase 5 Database Schema Additions](./phase-5-additions.md#phase-5-database-schema-additions)
      - [HomeKit Pairings Table](./phase-5-additions.md#homekit-pairings-table)
      - [Detection Schedule Extensions](./phase-5-additions.md#detection-schedule-extensions)
      - [Detection Zone Presets](./phase-5-additions.md#detection-zone-presets)
    - [Phase 5 HomeKit Architecture](./phase-5-additions.md#phase-5-homekit-architecture)
      - [HAP Bridge Design](./phase-5-additions.md#hap-bridge-design)
      - [Camera Streaming Pipeline](./phase-5-additions.md#camera-streaming-pipeline)
      - [Sensor State Management](./phase-5-additions.md#sensor-state-management)
    - [Phase 5 ONVIF Discovery Architecture](./phase-5-additions.md#phase-5-onvif-discovery-architecture)
      - [WS-Discovery Flow](./phase-5-additions.md#ws-discovery-flow)
      - [Discovery Service Implementation](./phase-5-additions.md#discovery-service-implementation)
    - [Phase 5 CI/CD Architecture](./phase-5-additions.md#phase-5-cicd-architecture)
      - [GitHub Actions Workflow](./phase-5-additions.md#github-actions-workflow)
      - [Frontend Test Configuration](./phase-5-additions.md#frontend-test-configuration)
    - [Phase 5 API Additions](./phase-5-additions.md#phase-5-api-additions)
      - [HomeKit Endpoints](./phase-5-additions.md#homekit-endpoints)
      - [Camera Discovery Endpoints](./phase-5-additions.md#camera-discovery-endpoints)
    - [Phase 5 Implementation Patterns](./phase-5-additions.md#phase-5-implementation-patterns)
      - [HomeKit Event Integration](./phase-5-additions.md#homekit-event-integration)
      - [Accessibility Patterns](./phase-5-additions.md#accessibility-patterns)
      - [Zone Preset Application](./phase-5-additions.md#zone-preset-application)
    - [Phase 5 Performance Considerations](./phase-5-additions.md#phase-5-performance-considerations)
    - [Phase 5 Validation Checklist](./phase-5-additions.md#phase-5-validation-checklist)
  - [Phase 11 Additions](./phase-11-additions.md)
    - [Phase 11 Executive Summary](./phase-11-additions.md#phase-11-executive-summary)
    - [Phase 11 Technology Stack Additions](./phase-11-additions.md#phase-11-technology-stack-additions)
    - [Phase 11 Project Structure Additions](./phase-11-additions.md#phase-11-project-structure-additions)
    - [Phase 11 Database Schema Additions](./phase-11-additions.md#phase-11-database-schema-additions)
      - [Device Model](./phase-11-additions.md#device-model)
      - [FrameEmbedding Model](./phase-11-additions.md#frameembedding-model)
    - [Phase 11 Service Architecture](./phase-11-additions.md#phase-11-service-architecture)
      - [APNSProvider](./phase-11-additions.md#apnsprovider)
      - [FCMProvider](./phase-11-additions.md#fcmprovider)
      - [PushDispatchService](./phase-11-additions.md#pushdispatchservice)
      - [TunnelService](./phase-11-additions.md#tunnelservice)
      - [MCPContextProvider](./phase-11-additions.md#mcpcontextprovider)
      - [EmbeddingService Extensions](./phase-11-additions.md#embeddingservice-extensions)
    - [Phase 11 API Contracts](./phase-11-additions.md#phase-11-api-contracts)
      - [Device Management Endpoints](./phase-11-additions.md#device-management-endpoints)
      - [Tunnel Status Endpoint](./phase-11-additions.md#tunnel-status-endpoint)
      - [Smart Reanalyze Endpoint](./phase-11-additions.md#smart-reanalyze-endpoint)
    - [Phase 11 Architecture Decision Records](./phase-11-additions.md#phase-11-architecture-decision-records)
      - [ADR-P11-001: Cloudflare Tunnel for Remote Access](./phase-11-additions.md#adr-p11-001-cloudflare-tunnel-for-remote-access)
      - [ADR-P11-002: Native Push Providers over Firebase Unified](./phase-11-additions.md#adr-p11-002-native-push-providers-over-firebase-unified)
      - [ADR-P11-003: MCP Context via Database Queries](./phase-11-additions.md#adr-p11-003-mcp-context-via-database-queries)
      - [ADR-P11-004: CLIP for Text-Frame Matching](./phase-11-additions.md#adr-p11-004-clip-for-text-frame-matching)
    - [Phase 11 Performance Considerations](./phase-11-additions.md#phase-11-performance-considerations)
    - [Phase 11 Validation Checklist](./phase-11-additions.md#phase-11-validation-checklist)
  - [Phase 12 Additions](./phase-12-additions.md)
    - [Phase 12 Executive Summary](./phase-12-additions.md#phase-12-executive-summary)
    - [Phase 12 Technology Stack Additions](./phase-12-additions.md#phase-12-technology-stack-additions)
    - [Phase 12 Project Structure Additions](./phase-12-additions.md#phase-12-project-structure-additions)
    - [Phase 12 Database Schema Additions](./phase-12-additions.md#phase-12-database-schema-additions)
      - [AlertRule Extension](./phase-12-additions.md#alertrule-extension-p12-1)
      - [PairingCode Model](./phase-12-additions.md#pairingcode-model-p12-3)
      - [RefreshToken Model](./phase-12-additions.md#refreshtoken-model-p12-3)
    - [Phase 12 Service Architecture](./phase-12-additions.md#phase-12-service-architecture)
      - [Entity Alert Evaluation Flow](./phase-12-additions.md#entity-alert-evaluation-flow)
      - [Mobile Device Pairing Flow](./phase-12-additions.md#mobile-device-pairing-flow-p12-3)
      - [PairingService](./phase-12-additions.md#pairing-service-p12-3)
      - [TokenService](./phase-12-additions.md#token-service-with-refresh-rotation-p12-3)
      - [BatchEmbedder](./phase-12-additions.md#query-adaptive-batch-embedder-p12-4)
      - [DiversityFilter](./phase-12-additions.md#diversity-filter-p12-4)
    - [Phase 12 API Contracts](./phase-12-additions.md#phase-12-api-contracts)
      - [Entity Alert Rules API](./phase-12-additions.md#entity-alert-rules-api-p12-1)
      - [Mobile Pairing API](./phase-12-additions.md#mobile-pairing-api-p12-3)
      - [Device Management Extension](./phase-12-additions.md#device-management-api-extension-p12-2)
    - [Phase 12 Architecture Decision Records](./phase-12-additions.md#phase-12-adrs)
      - [ADR-P12-001: 6-Digit Pairing Codes](./phase-12-additions.md#adr-p12-001-6-digit-pairing-codes-over-qr-codes)
      - [ADR-P12-002: Refresh Token Rotation](./phase-12-additions.md#adr-p12-002-refresh-token-rotation)
      - [ADR-P12-003: Entity Match Modes](./phase-12-additions.md#adr-p12-003-entity-match-modes-for-alert-rules)
      - [ADR-P12-004: Batch Embedding with Diversity](./phase-12-additions.md#adr-p12-004-batch-embedding-with-diversity-filtering)
    - [Phase 12 Performance Considerations](./phase-12-additions.md#phase-12-performance-considerations)
    - [Phase 12 Validation Checklist](./phase-12-additions.md#phase-12-validation-checklist)
