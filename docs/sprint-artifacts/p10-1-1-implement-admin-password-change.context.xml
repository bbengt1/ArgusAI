<story-context id="p10-1-1" v="1.0">
  <metadata>
    <epicId>P10-1</epicId>
    <storyId>1</storyId>
    <title>Implement Admin Password Change</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p10-1-1-implement-admin-password-change.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to change my admin password through the Settings UI</iWant>
    <soThat>I can maintain account security</soThat>
    <tasks>
      <task id="1" status="done">Verify backend API exists - COMPLETE at backend/app/api/v1/auth.py:250-302</task>
      <task id="2">Add API client method for password change - ALREADY EXISTS at frontend/lib/api-client.ts:955-960</task>
      <task id="3">Create PasswordChangeForm component</task>
      <task id="4">Integrate into Settings page</task>
      <task id="5">Write tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Settings page has password change section (General tab or new Security section)</criterion>
    <criterion id="2">Form has fields: Current Password, New Password, Confirm New Password</criterion>
    <criterion id="3">Successful change shows toast "Password updated successfully" and session remains active</criterion>
    <criterion id="4">Incorrect current password shows error "Current password is incorrect"</criterion>
    <criterion id="5">Weak password shows requirements message</criterion>
    <criterion id="6">Mismatched passwords show "Passwords do not match"</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture/security-architecture.md</path>
        <title>Security Architecture</title>
        <section>Authentication Flow</section>
        <snippet>JWT-based authentication with bcrypt password hashing. Passwords validated for 8+ chars, uppercase, number, special char.</snippet>
      </doc>
      <doc>
        <path>docs/epics-phase10.md</path>
        <title>Phase 10 Epics</title>
        <section>Story P10-1.1</section>
        <snippet>Implement admin password change functionality through Settings UI with current password verification.</snippet>
      </doc>
      <doc>
        <path>docs/PRD-phase10.md</path>
        <title>Phase 10 PRD</title>
        <section>Bug Fix Requirements FR1-FR3</section>
        <snippet>Users can change admin password through Settings UI with current password verification and clear feedback.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>backend/app/api/v1/auth.py</path>
        <kind>router</kind>
        <symbol>change_password</symbol>
        <lines>250-302</lines>
        <reason>Backend endpoint already implemented - POST /api/v1/auth/change-password</reason>
      </file>
      <file>
        <path>backend/app/schemas/auth.py</path>
        <kind>schema</kind>
        <symbol>ChangePasswordRequest</symbol>
        <lines>32-35</lines>
        <reason>Pydantic schema for password change request</reason>
      </file>
      <file>
        <path>backend/app/utils/auth.py</path>
        <kind>utility</kind>
        <symbol>validate_password_strength</symbol>
        <lines>N/A</lines>
        <reason>Password validation logic - 8+ chars, uppercase, number, special char</reason>
      </file>
      <file>
        <path>frontend/lib/api-client.ts</path>
        <kind>api-client</kind>
        <symbol>apiClient.auth.changePassword</symbol>
        <lines>955-960</lines>
        <reason>API client method already exists for calling change-password endpoint</reason>
      </file>
      <file>
        <path>frontend/types/auth.ts</path>
        <kind>types</kind>
        <symbol>IChangePasswordRequest</symbol>
        <lines>24-27</lines>
        <reason>TypeScript interface for password change request</reason>
      </file>
      <file>
        <path>frontend/app/settings/page.tsx</path>
        <kind>page</kind>
        <symbol>SettingsPage</symbol>
        <lines>1-1331</lines>
        <reason>Settings page where PasswordChangeForm should be integrated</reason>
      </file>
      <file>
        <path>frontend/components/settings/AIProviders.tsx</path>
        <kind>component</kind>
        <symbol>AIProviders</symbol>
        <lines>N/A</lines>
        <reason>Reference component for settings form patterns with Card layout</reason>
      </file>
      <file>
        <path>frontend/components/settings/MQTTSettings.tsx</path>
        <kind>component</kind>
        <symbol>MQTTSettings</symbol>
        <lines>N/A</lines>
        <reason>Reference component for form with password field patterns</reason>
      </file>
    </code>

    <dependencies>
      <frontend>
        <package name="react" version="^19.0.0" />
        <package name="react-hook-form" version="^7.54.2" />
        <package name="@hookform/resolvers" version="^3.9.1" />
        <package name="zod" version="^3.24.1" />
        <package name="sonner" version="^1.7.1" />
        <package name="lucide-react" version="^0.468.0" />
        <package name="@radix-ui/react-*" purpose="shadcn/ui components" />
      </frontend>
      <backend>
        <package name="fastapi" version="~0.115" />
        <package name="bcrypt" purpose="password hashing" />
        <package name="pydantic" version="^2.0" />
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Follow existing settings component patterns (Card, react-hook-form, zod validation)</constraint>
    <constraint>Use shadcn/ui components (Input, Button, Card, Label, Form)</constraint>
    <constraint>Use toast from sonner for notifications</constraint>
    <constraint>Password requirements: 8+ chars, 1 uppercase, 1 number, 1 special character</constraint>
    <constraint>Must verify current password before allowing change</constraint>
    <constraint>Session must remain active after password change</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/v1/auth/change-password</name>
      <kind>REST endpoint</kind>
      <signature>Request: { current_password: string, new_password: string } â†’ Response: { message: string }</signature>
      <path>backend/app/api/v1/auth.py:250</path>
    </interface>
    <interface>
      <name>apiClient.auth.changePassword</name>
      <kind>TypeScript function</kind>
      <signature>(request: IChangePasswordRequest) => Promise&lt;IMessageResponse&gt;</signature>
      <path>frontend/lib/api-client.ts:955</path>
    </interface>
    <interface>
      <name>IChangePasswordRequest</name>
      <kind>TypeScript interface</kind>
      <signature>{ current_password: string; new_password: string; }</signature>
      <path>frontend/types/auth.ts:24</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Frontend tests use Vitest with React Testing Library. Tests are colocated in __tests__ directories.
      Follow existing test patterns in frontend/__tests__/components/settings/*.test.tsx.
      Test form validation, API error handling, and success flows.
    </standards>
    <locations>
      <location>frontend/__tests__/components/settings/</location>
    </locations>
    <ideas>
      <idea ac="2">Test form renders with all three password fields</idea>
      <idea ac="3">Test successful password change shows success toast</idea>
      <idea ac="4">Test API error for incorrect current password displays error message</idea>
      <idea ac="5">Test client-side validation for weak passwords</idea>
      <idea ac="6">Test confirm password mismatch validation</idea>
      <idea ac="2">Test password visibility toggle functionality</idea>
    </ideas>
  </tests>
</story-context>
